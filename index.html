<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GlobalMediTH - Sistema de Cotizaci√≥n</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* Estilos Generales y Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; /* Asegura que el body ocupe toda la altura de la ventana */
      color: #333;
      /* overflow-y: hidden; Esto lo quitamos de body para que el scroll lo manejen los .screen si es necesario */
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      width: 100%;
    }

    /* Manejo de Pantallas */
    .screen {
      display: none; /* Por defecto, todas las pantallas est√°n ocultas */
      width: 100%;
      min-height: calc(100vh - 40px); /* Ajuste para el padding vertical del .container */
      padding: 0; /* Asegurar que no hay padding extra en la pantalla misma */
      box-sizing: border-box;
      /* overflow: hidden; Esto lo quitamos de .screen para que el scroll lo manejen los componentes internos */
    }
    
    .screen.active {
      display: block; /* Mostrar la pantalla activa como un bloque */
    }

    /* PANTALLA 1 - REGISTRO */
    .welcome-screen {
      display: flex; /* Usamos flex para centrar verticalmente el welcome-card */
      justify-content: center;
      align-items: center;
      min-height: calc(100vh - 40px); /* Asegura que esta pantalla tome al menos la altura de la vista */
    }

    .welcome-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 500px;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      /* max-height: calc(100vh - 80px); */ /* Deshabilitar si causa problemas y ajustar padding/font-size */
      /* overflow-y: auto; */ /* Deshabilitar si no es estrictamente necesario, confiar en el tama√±o */
    }

    .logo {
      margin-bottom: 15px;
    }

    .logo img {
      height: 100px;
      width: auto;
      border-radius: 10px;
      max-width: 100%;
    }

    .welcome-title {
      font-size: 1.8em;
      color: #2c3e50;
      margin-bottom: 8px;
      font-weight: 700;
    }

    .welcome-subtitle {
      font-size: 0.9em;
      color: #7f8c8d;
      margin-bottom: 12px;
    }

    .persuasive-message {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 12px;
      border-radius: 15px;
      margin-bottom: 15px;
      font-size: 0.9em;
      font-weight: 600;
      line-height: 1.3;
    }

    .medicine-types {
      display: flex;
      justify-content: space-around;
      margin-bottom: 15px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .medicine-type {
      text-align: center;
      flex: 1;
      min-width: 80px;
      max-width: 120px;
      padding: 3px;
    }

    .medicine-type i {
      font-size: 1.6em;
      margin-bottom: 5px;
      display: block;
    }

    .form-group {
      margin-bottom: 10px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 3px;
      font-weight: 600;
      color: #2c3e50;
      font-size: 0.9em;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.9em;
      transition: border-color 0.3s;
    }

    .btn {
      padding: 10px 25px;
      font-size: 0.95em;
      margin-top: 8px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .copyright {
        margin-top: 15px;
        font-size: 0.75em;
        color: #7f8c8d;
    }

    /* PANTALLA 2 - CAT√ÅLOGO */
    .catalog-screen {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 20px;
      min-height: calc(100vh - 40px); /* Asegura que ocupe la altura de la vista */
      padding: 15px;
    }

    .catalog-main {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      height: 100%; /* Ocupa toda la altura disponible en la columna */
    }

    .catalog-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
      flex-shrink: 0;
    }

    .catalog-header .logo-small {
        height: 50px;
        flex-shrink: 0;
    }

    .catalog-header .header-text-group {
        flex-grow: 1;
        min-width: 0;
    }

    .catalog-header .persuasive-text-small {
        font-size: 0.8em;
        color: #6c757d;
        text-align: left;
        line-height: 1.2;
    }

    .catalog-title {
      font-size: 1.6em;
      margin-bottom: 5px;
      color: #2c3e50;
      font-weight: 700;
    }

    .search-box {
      margin-bottom: 15px;
      flex-shrink: 0;
    }

    .search-box input {
      width: 100%;
      padding: 10px 35px 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 50px;
      font-size: 0.9em;
    }

    .search-box i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #7f8c8d;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px;
      height: 100%; /* Ocupa toda la altura restante en la columna */
      overflow-y: auto; /* SCROLL INDIVIDUAL PARA EL GRID DE PRODUCTOS */
      padding-right: 8px;
      flex-grow: 1;
    }

    .product-card {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 12px;
      transition: all 0.3s;
      cursor: pointer;
      font-size: 0.9em;
    }

    .product-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
    }

    .product-card.selected {
      border-color: #28a745;
      background: #d4edda;
    }

    .product-card.hidden {
        display: none;
    }

    .product-title {
      font-size: 0.95em;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 6px;
      line-height: 1.2;
    }

    .product-info {
      font-size: 0.8em;
      color: #6c757d;
      margin-bottom: 4px;
    }

    .quantity-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .quantity-input {
      width: 45px;
      padding: 4px;
      border: 1px solid #ddd;
      border-radius: 5px;
      text-align: center;
      font-size: 0.8em;
    }

    /* CARRITO LATERAL */
    .cart-sidebar {
      background: white;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      height: 100%; /* Ocupar toda la altura de la pantalla */
      display: flex;
      flex-direction: column;
    }

    .cart-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 1.1em;
      font-weight: 700;
      color: #2c3e50;
      flex-shrink: 0;
    }

    .cart-items {
      flex-grow: 1; /* Permite que los items crezcan y tomen el espacio disponible */
      overflow-y: auto; /* SCROLL INDIVIDUAL PARA LOS ITEMS DEL CARRITO */
      margin-bottom: 10px;
      padding-right: 5px;
    }

    .cart-item {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 6px;
      position: relative;
    }

    .cart-item-title {
      font-weight: 600;
      font-size: 0.8em;
      margin-bottom: 3px;
      line-height: 1.2;
    }

    .cart-item-info {
      font-size: 0.7em;
      color: #6c757d;
    }

    .cart-item-quantity {
      position: absolute;
      top: 6px;
      right: 25px;
      background: #667eea;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7em;
      font-weight: bold;
    }

    .remove-item {
      position: absolute;
      top: 6px;
      right: 6px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6em;
      cursor: pointer;
    }

    .cart-summary {
      border-top: 2px solid #e9ecef;
      padding-top: 10px;
      text-align: center;
      margin-top: auto; /* Empuja el resumen al final */
      flex-shrink: 0;
    }

    .cart-total {
      font-size: 1em;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .btn-success {
      background: #28a745;
    }

    /* PANTALLA 3 - RESUMEN */
    .summary-screen {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      max-width: 800px;
      width: 100%;
      min-height: calc(100vh - 40px); /* Asegura que ocupe la altura de la vista */
      display: flex;
      flex-direction: column;
      overflow-y: hidden; /* Controlar scroll en el contenedor de tabla */
    }

    .summary-header {
      text-align: center;
      margin-bottom: 20px;
      flex-shrink: 0;
    }

    .summary-logo {
      margin-bottom: 10px;
    }

    .summary-logo img {
      height: 80px;
      width: auto;
      max-width: 100%;
    }

    .summary-title {
      font-size: 1.8em;
      color: #2c3e50;
      margin-bottom: 8px;
      font-weight: 700;
    }

    .contact-info, .client-info, .products-summary {
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 15px;
      flex-shrink: 0;
    }
    .contact-info { background: #f8f9fa; }
    .client-info { background: #e3f2fd; }
    .products-summary { 
        background: #f1f8e9;
        flex-grow: 1; /* Permite que la tabla de productos crezca */
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Ocultar scroll si no es necesario en el table-container */
    }
    
    .summary-table-container {
        flex-grow: 1;
        overflow-y: auto; /* SCROLL INDIVIDUAL PARA LA TABLA DE PRODUCTOS */
        padding-right: 5px;
    }

    .contact-info h3, .client-info h3, .products-summary h3 {
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 1em;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      color: #495057;
      font-size: 0.85em;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    .summary-table th,
    .summary-table td {
      padding: 7px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      font-size: 0.8em;
    }

    .summary-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
    }

    .summary-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
      flex-shrink: 0;
    }

    .btn-secondary { background: #6c757d; }
    .btn-whatsapp { background: #25D366; }

    /* Navegaci√≥n (Bot√≥n de Regresar) */
    .navigation {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
    }

    .nav-btn {
      background: rgba(255,255,255,0.9);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1em;
      color: #2c3e50;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: all 0.3s;
    }

    .nav-btn:hover {
      transform: scale(1.1);
    }

    /* Responsive Media Queries */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      .screen {
        min-height: calc(100vh - 20px); /* Ajustar a padding de container en m√≥vil */
      }
      
      .welcome-card {
        padding: 15px;
        max-height: calc(100vh - 40px); /* Ajustar max-height para m√≥vil */
      }
      .logo img {
        height: 70px;
      }
      .welcome-title {
        font-size: 1.6em;
      }
      .welcome-subtitle, .persuasive-message {
        font-size: 0.85em;
        padding: 10px;
      }
      .medicine-types {
        flex-direction: column;
        gap: 5px;
        margin-bottom: 10px;
      }
      .medicine-type {
        min-width: unset;
        max-width: unset;
        width: 100%;
        font-size: 0.9em;
      }
      .form-group label {
        font-size: 0.85em;
      }
      .form-group input {
        padding: 8px;
        font-size: 0.85em;
      }
      .btn {
        padding: 8px 15px;
        font-size: 0.9em;
        width: 100%; /* Botones de ancho completo */
      }
      .copyright {
        font-size: 0.7em;
        margin-top: 10px;
      }

      .catalog-screen {
        grid-template-columns: 1fr; /* Una columna para el cat√°logo y el carrito */
        padding: 10px;
        gap: 10px;
        min-height: unset; /* Quitar min-height, dejar que el contenido defina la altura */
      }
      .catalog-main, .cart-sidebar {
        height: auto; /* Dejar que la altura se ajuste al contenido */
        padding: 15px;
        min-height: unset; /* Asegurar que no hay altura m√≠nima fija en m√≥vil */
      }
      .products-grid {
        max-height: 350px; /* Definir un max-height fijo para el scroll del grid en m√≥vil */
        height: auto;
      }
      .cart-items {
        max-height: 250px; /* Definir un max-height fijo para el scroll del carrito en m√≥vil */
        height: auto;
      }
      .catalog-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
      .catalog-header .logo-small {
        height: 40px;
        margin-bottom: 5px;
      }
      .catalog-title {
        font-size: 1.4em;
      }
      .catalog-header .persuasive-text-small {
        font-size: 0.75em;
      }
      .search-box {
        margin-bottom: 10px;
      }
      .search-box input {
        padding: 8px 30px 8px 12px;
        font-size: 0.85em;
      }
      .product-card {
        padding: 10px;
      }
      .product-title {
        font-size: 0.9em;
      }
      .product-info {
        font-size: 0.75em;
      }
      .quantity-input {
        width: 40px;
        font-size: 0.8em;
      }
      
      .cart-header {
        font-size: 1em;
      }
      .cart-item {
        padding: 8px;
      }
      .cart-item-title {
        font-size: 0.75em;
      }
      .cart-item-info {
        font-size: 0.65em;
      }
      .cart-item-quantity {
        width: 18px;
        height: 18px;
        font-size: 0.65em;
      }
      .remove-item {
        width: 14px;
        height: 14px;
        font-size: 0.55em;
      }
      .cart-total {
        font-size: 0.9em;
      }

      .summary-screen {
        padding: 15px;
        min-height: unset; /* Quitar min-height para m√≥vil */
        height: auto; /* Altura auto para que se ajuste al contenido */
      }
      .summary-title {
        font-size: 1.6em;
      }
      .contact-info, .client-info, .products-summary {
        padding: 10px;
        margin-bottom: 10px;
      }
      .contact-info h3, .client-info h3, .products-summary h3 {
        font-size: 0.95em;
      }
      .contact-item {
        font-size: 0.75em;
      }
      .summary-table th, .summary-table td {
        padding: 6px;
        font-size: 0.7em;
      }
      .summary-actions {
        gap: 8px;
      }
      .nav-btn {
        width: 35px;
        height: 35px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <div class="navigation">
    <button class="nav-btn" onclick="goBack()" id="backBtn" style="display: none;">
      <i class="fas fa-arrow-left"></i>
    </button>
  </div>

  <div class="container">
    <div id="screen1" class="screen active">
      <div class="welcome-screen">
        <div class="welcome-card">
          <div class="logo">
            <img src="logo.png" alt="GlobalMediTH Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDE1MCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMjc0OWI4Ii8+Cjx0ZXh0IHg9Ijc1IiB5PSI0NSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkdsb2JhbE1lZGlUSDwvdGV4dD4KPHRleHQgeD0iNzUiIHk9IjY1IiBmYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+TWVkaWNhbWVudG9zPC90ZXh0Pgo8L3N2Zz4='"/>
          </div>
          
          <h1 class="welcome-title">Bienvenido</h1>
          <p class="welcome-subtitle">Sistema de Cotizaci√≥n Profesional</p>
          
          <div class="persuasive-message">
            <i class="fas fa-star"></i>
            ¬°Solicita tu pedido ahora y recibe atenci√≥n personalizada! Nuestros medicamentos de calidad est√°n listos para ti.
          </div>

          <div class="medicine-types">
            <div class="medicine-type patente">
              <i class="fas fa-certificate"></i>
              <strong>Patente</strong>
            </div>
            <div class="medicine-type genericos">
              <i class="fas fa-pills"></i>
              <strong>Gen√©ricos</strong>
            </div>
            <div class="medicine-type curacion">
              <i class="fas fa-first-aid"></i>
              <strong>Material de Curaci√≥n</strong>
            </div>
          </div>

          <form id="clientForm">
            <div class="form-group">
              <label for="nombre"><i class="fas fa-user"></i> Nombre Completo</label>
              <input type="text" id="nombre" required />
            </div>
            <div class="form-group">
              <label for="celular"><i class="fas fa-phone"></i> N√∫mero de Celular</label>
              <input type="tel" id="celular" required />
            </div>
            <div class="form-group">
              <label for="ciudad"><i class="fas fa-map-marker-alt"></i> Ciudad</label>
              <input type="text" id="ciudad" required />
            </div>
            <div class="form-group">
              <label for="correo"><i class="fas fa-envelope"></i> Correo Electr√≥nico</label>
              <input type="email" id="correo" required />
            </div>
            
            <button type="submit" class="btn">
              <i class="fas fa-arrow-right"></i>
              Continuar al Cat√°logo
            </button>
          </form>
          <div class="copyright">
              Todos los derechos reservados 2025.
          </div>
        </div>
      </div>
    </div>

    <div id="screen2" class="screen">
      <div class="catalog-screen">
        <div class="catalog-main">
          <div class="catalog-header">
            <img src="logo.png" alt="GlobalMediTH Logo" class="logo-small" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iMzAiIHZpZXdCb3g9IjAgMCA1MCAzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjMjc0OWI4Ii8+Cjx0ZXh0IHg9IjI1IiB5PSIxOCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjUiIGZvbnQtd2VpZ2h0PSJib2x0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+R0xPQkFMIDwvdGV4dD4KPHRleHQgeD0iMjUiIHk9IjI1IiBmYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjMiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5NRURJVEg8L3RleHQ+Cjwvc3ZnPg=='"/>
            <div class="header-text-group">
                <h2 class="catalog-title">
                  <i class="fas fa-pills"></i>
                  Cat√°logo de Medicamentos
                </h2>
                <p class="persuasive-text-small">
                    Explora nuestra amplia selecci√≥n de medicamentos de calidad garantizada. ¬°Tu salud es nuestra prioridad!
                </p>
            </div>
          </div>
          
          <div class="search-box">
            <input type="text" id="busqueda" placeholder="Buscar por descripci√≥n, f√≥rmula o laboratorio..." />
            <i class="fas fa-search"></i>
          </div>

          <div class="products-grid" id="productsGrid">
            </div>
        </div>

        <div class="cart-sidebar">
          <div class="cart-header">
            <i class="fas fa-shopping-cart"></i>
            Cotizaci√≥n
          </div>
          
          <div class="cart-items" id="cartItems">
            <p style="text-align: center; color: #6c757d; font-style: italic;">
              No hay productos seleccionados
            </p>
          </div>
          
          <div class="cart-summary">
            <div class="cart-total" id="cartTotal">
              Total: 0 producto(s)
            </div>
            <button class="btn btn-success" onclick="goToSummary()" id="quoteBtnMain" disabled>
              <i class="fas fa-file-invoice"></i>
              Generar Cotizaci√≥n
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="screen3" class="screen">
      <div class="summary-screen">
        <div class="summary-header">
          <div class="summary-logo">
            <img src="logo.png" alt="GlobalMediTH Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDE1MCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMjc0OWI4Ii8+Cjx0ZXh0IHg9Ijc1IiB5PSI0NSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkdsb2JhbE1lZGlUSDwvdGV4dD4KPHRleHQgeD0iNzUiIHk9IjY1IiBmYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+TWVkaWNhbWVudG9zPC90ZXh0Pgo8L3N2Zz4='"/>
          </div>
          <h1 class="summary-title">Cotizaci√≥n - GlobalMediTH</h1>
          <div class="persuasive-message">
            <i class="fas fa-star"></i>
            ¬°Medicamentos de calidad con atenci√≥n personalizada para tu tranquilidad!
          </div>
        </div>

        <div class="contact-info">
          <h3><i class="fas fa-info-circle"></i> Datos de Contacto de Ventas</h3>
          <div class="contact-item">
            <i class="fas fa-phone"></i>
            <span>Celular: 2381646718</span>
          </div>
          <div class="contact-item">
            <i class="fas fa-envelope"></i>
            <span>Correo: globalmedith@gmail.com</span>
          </div>
          <div class="contact-item">
            <i class="fas fa-map-marker-alt"></i>
            <span>Ubicaci√≥n: Tehuac√°n, Puebla</span>
          </div>
        </div>

        <div class="client-info">
          <h3><i class="fas fa-user"></i> Datos del Cliente</h3>
          <div id="clientSummary">
            </div>
        </div>

        <div class="products-summary">
          <h3><i class="fas fa-pills"></i> Productos Seleccionados</h3>
          <div class="summary-table-container">
            <table class="summary-table" id="summaryTable">
              <thead>
                <tr>
                  <th>C√≥digo de Barras</th>
                  <th>Descripci√≥n</th>
                  <th>F√≥rmula</th>
                  <th>Laboratorio</th>
                  <th>Cantidad</th>
                </tr>
              </thead>
              <tbody>
                </tbody>
            </table>
          </div>
        </div>

        <div class="summary-actions">
          <button class="btn btn-secondary" onclick="goToScreen(2)">
            <i class="fas fa-arrow-left"></i>
            Regresar al Cat√°logo
          </button>
          <button class="btn" onclick="generarPDF()">
            <i class="fas fa-file-pdf"></i>
            Descargar PDF
          </button>
          <button class="btn btn-whatsapp" onclick="enviarWhatsApp()">
            <i class="fab fa-whatsapp"></i>
            Enviar por WhatsApp
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let medicamentos = [];
    let selectedProducts = new Map();
    let currentScreen = 1;
    let clientData = {};

    // Funci√≥n para obtener la imagen en Base64 (para PDF)
    function getBase64Image(imgUrl, callback) {
        var img = new Image();
        img.src = imgUrl;
        img.onload = function () {
            var canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            var ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            var dataURL = canvas.toDataURL("image/png");
            callback(dataURL);
        };
        img.onerror = function() {
            console.error("Error al cargar la imagen para Base64. Usando fallback SVG.");
            // SVG de fallback para el logo si logo.png no carga
            const fallbackSvg = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDE1MCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMjc0OWI4Ii8+Cjx0ZXh0IHg9Ijc1IiB5PSI0NSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkdsb2JhbE1lZGlUSDwvdGV4dD4KPHRleHQgeD0iNzUiIHk9IjY1IiBmYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+TWVkaWNhbWVudG9zPC90ZXh0Pgo8L3N2Zz4=';
            callback(fallbackSvg);
        };
    }

    // Navegaci√≥n entre pantallas
    function goToScreen(screenNumber) {
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });
      document.getElementById(`screen${screenNumber}`).classList.add('active');
      currentScreen = screenNumber;
      
      const backBtn = document.getElementById('backBtn');
      backBtn.style.display = screenNumber > 1 ? 'block' : 'none';

      if (screenNumber === 3) {
        populateSummary();
      }
    }

    function goBack() {
      if (currentScreen > 1) {
        goToScreen(currentScreen - 1);
      }
    }

    // Formulario de cliente
    document.getElementById('clientForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      clientData = {
        nombre: document.getElementById('nombre').value,
        celular: document.getElementById('celular').value,
        ciudad: document.getElementById('ciudad').value,
        correo: document.getElementById('correo').value
      };
      
      goToScreen(2);
    });

    // Cargar medicamentos
    window.onload = async () => {
      try {
        const res = await fetch('medicamentos.json');
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        medicamentos = await res.json();
        // Asumiendo que la primera fila es una cabecera si tiene "Codigo de Barras"
        if (medicamentos.length > 0 && medicamentos[0].codigoBarras === "Codigo de Barras") {
          medicamentos.shift(); // Elimina la fila de cabecera
        }
        renderProducts(medicamentos); // Renderiza todos los productos inicialmente
      } catch (error) {
        console.error("Error al cargar los medicamentos:", error);
        document.getElementById('productsGrid').innerHTML = 
          "<p style='text-align: center; color: #dc3545;'>Error al cargar el cat√°logo. Por favor, aseg√∫rese que 'medicamentos.json' existe y es accesible.</p>";
      }
    };

    // Renderizar productos en el cat√°logo (Optimizado para evitar re-renderizado completo)
    // Este renderizado solo se ejecuta la primera vez que se carga el cat√°logo,
    // o si el conjunto de datos `medicamentos` cambia dr√°sticamente.
    // Las b√∫squedas y selecciones posteriores solo ocultan/muestran y actualizan clases.
    function renderProducts(productsToDisplay) {
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = ''; // Limpiar el grid para un nuevo renderizado completo
        
        if (productsToDisplay.length === 0) {
            grid.innerHTML = "<p style='text-align: center; color: #6c757d;'>No se encontraron medicamentos.</p>";
            return;
        }

        productsToDisplay.forEach((product) => {
            const isSelected = selectedProducts.has(product.codigoBarras);
            const quantity = isSelected ? selectedProducts.get(product.codigoBarras).cantidad : 1;

            const card = document.createElement('div');
            card.id = `product-card-${product.codigoBarras}`; // Asigna un ID √∫nico a cada tarjeta
            card.className = `product-card ${isSelected ? 'selected' : ''}`;
            
            card.onclick = () => toggleProduct(product);
            
            card.innerHTML = `
                <div class="product-title">${product.descripcion || 'Sin descripci√≥n'}</div>
                <div class="product-info"><strong>F√≥rmula:</strong> ${product.formula || 'No especificada'}</div>
                <div class="product-info"><strong>Laboratorio:</strong> ${product.laboratorio || 'No especificado'}</div>
                <div class="product-info"><strong>C√≥digo:</strong> ${product.codigoBarras || 'No disponible'}</div>
                <div class="quantity-selector" onclick="event.stopPropagation()">
                    <label>Cantidad:</label>
                    <input type="number" class="quantity-input" min="1" value="${quantity}" 
                           onchange="updateQuantity('${product.codigoBarras}', this.value)" />
                </div>
            `;
            grid.appendChild(card);
        });
        updateCart(); // Asegura que el carrito se actualice despu√©s de renderizar productos
    }

    // Alternar selecci√≥n de producto (OPTIMIZADO)
    function toggleProduct(product) {
        const cardElement = document.getElementById(`product-card-${product.codigoBarras}`);
        
        if (selectedProducts.has(product.codigoBarras)) {
            selectedProducts.delete(product.codigoBarras);
            if (cardElement) {
                cardElement.classList.remove('selected');
            }
        } else {
            selectedProducts.set(product.codigoBarras, { ...product, cantidad: 1 });
            if (cardElement) {
                cardElement.classList.add('selected');
                const quantityInput = cardElement.querySelector('.quantity-input');
                if (quantityInput) {
                    quantityInput.value = 1; // Asegura que la cantidad sea 1 al seleccionar
                }
            }
        }
        updateCart(); // Actualiza el carrito despu√©s de la selecci√≥n
    }

    // Actualizar cantidad de un producto seleccionado
    function updateQuantity(codigo, cantidad) {
      const qty = parseInt(cantidad) || 1;
      if (qty < 1) { 
        const cardElement = document.getElementById(`product-card-${codigo}`);
        if (cardElement) {
            cardElement.querySelector('.quantity-input').value = 1;
        }
        cantidad = 1;
      }
      
      if (selectedProducts.has(codigo)) {
        const product = selectedProducts.get(codigo);
        product.cantidad = parseInt(cantidad);
        selectedProducts.set(codigo, product);
        updateCart();
      }
    }

    // Eliminar producto del carrito (bot√≥n 'x' en el carrito)
    function removeItemFromCart(codigo) {
      selectedProducts.delete(codigo);
      const cardElement = document.getElementById(`product-card-${codigo}`);
      if (cardElement) {
          cardElement.classList.remove('selected');
          const quantityInput = cardElement.querySelector('.quantity-input');
            if (quantityInput) {
                quantityInput.value = 1;
            }
      }
      updateCart();
    }

    // Actualizar la vista del carrito lateral
    function updateCart() {
      const cartItems = document.getElementById('cartItems');
      const cartTotal = document.getElementById('cartTotal');
      const quoteBtn = document.getElementById('quoteBtnMain');
      
      if (selectedProducts.size === 0) {
        cartItems.innerHTML = "<p style='text-align: center; color: #6c757d; font-style: italic;'>No hay productos seleccionados</p>";
        cartTotal.textContent = "Total: 0 producto(s)";
        quoteBtn.disabled = true;
        return;
      }

      let html = '';
      let totalItems = 0;
      
      selectedProducts.forEach((product) => {
        totalItems += product.cantidad;
        html += `
          <div class="cart-item">
            <div class="cart-item-title">${product.descripcion || 'Producto sin descripci√≥n'}</div>
            <div class="cart-item-info">C√≥digo: ${product.codigoBarras || 'N/A'}</div>
            <div class="cart-item-quantity">${product.cantidad}</div>
            <button class="remove-item" onclick="removeItemFromCart('${product.codigoBarras}')">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
      });
      
      cartItems.innerHTML = html;
      cartTotal.textContent = `Total: ${totalItems} producto(s)`;
      quoteBtn.disabled = false;
    }

    // B√∫squeda de productos en tiempo real (OPTIMIZADO)
    document.getElementById('busqueda').addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      // No re-renderizamos, solo mostramos/ocultamos elementos existentes
      medicamentos.forEach(product => {
        const cardElement = document.getElementById(`product-card-${product.codigoBarras}`);
        if (cardElement) {
          if (filterProduct(product, searchTerm)) {
            cardElement.classList.remove('hidden');
          } else {
            cardElement.classList.add('hidden');
          }
        }
      });
    });

    // Funci√≥n auxiliar para filtrar productos
    function filterProduct(product, searchTerm) {
      const desc = (product.descripcion || '').toLowerCase();
      const formula = (product.formula || '').toLowerCase();
      const laboratorio = (product.laboratorio || '').toLowerCase();
      const codigoBarras = (product.codigoBarras || '').toLowerCase();

      return desc.includes(searchTerm) ||
             formula.includes(searchTerm) ||
             laboratorio.includes(searchTerm) ||
             codigoBarras.includes(searchTerm);
    }

    // Ir a la pantalla de resumen
    function goToSummary() {
      if (selectedProducts.size === 0) {
        alert("Por favor, selecciona al menos un producto para generar la cotizaci√≥n.");
        return;
      }
      populateSummary();
      goToScreen(3);
    }

    // Llenar datos en la pantalla de resumen (Screen 3)
    function populateSummary() {
      const clientSummaryDiv = document.getElementById('clientSummary');
      clientSummaryDiv.innerHTML = `
        <div class="contact-item">
          <i class="fas fa-user"></i>
          <span>Nombre: ${clientData.nombre || 'N/A'}</span>
        </div>
        <div class="contact-item">
          <i class="fas fa-phone"></i>
          <span>Celular: ${clientData.celular || 'N/A'}</span>
        </div>
        <div class="contact-item">
          <i class="fas fa-map-marker-alt"></i>
          <span>Ciudad: ${clientData.ciudad || 'N/A'}</span>
        </div>
        <div class="contact-item">
          <i class="fas fa-envelope"></i>
          <span>Correo: ${clientData.correo || 'N/A'}</span>
        </div>
      `;

      const summaryTableBody = document.querySelector('#summaryTable tbody');
      summaryTableBody.innerHTML = '';
      selectedProducts.forEach(product => {
        const row = summaryTableBody.insertRow();
        row.insertCell().textContent = product.codigoBarras || 'N/A';
        row.insertCell().textContent = product.descripcion || 'Sin descripci√≥n';
        row.insertCell().textContent = product.formula || 'No especificada';
        row.insertCell().textContent = product.laboratorio || 'No especificado';
        row.insertCell().textContent = product.cantidad;
      });
    }

    // Generar PDF
    async function generarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      getBase64Image('logo.png', function(logoBase64) {
          const pageWidth = doc.internal.pageSize.getWidth();
          const imgWidth = 40;
          const imgHeight = (imgWidth * 420) / 1488;
          const imgX = (pageWidth - imgWidth) / 2;

          if (logoBase64) {
              doc.addImage(logoBase64, 'PNG', imgX, 15, imgWidth, imgHeight);
          } else {
              doc.addImage(document.querySelector('.summary-logo img').src, 'JPEG', imgX, 15, imgWidth, imgHeight);
          }
          
          let y = 15 + imgHeight + 10;

          doc.setFontSize(18);
          doc.setTextColor(44, 62, 80);
          doc.text("Cotizaci√≥n GlobalMediTH", pageWidth / 2, y, { align: "center" });
          y += 8;
          doc.setFontSize(9);
          doc.setTextColor(50, 150, 70);
          doc.text("¬°Medicamentos de calidad con atenci√≥n personalizada para tu tranquilidad!", pageWidth / 2, y, { align: "center" });
          y += 15;

          doc.setFontSize(11);
          doc.setTextColor(0, 0, 0);

          // Datos de Contacto de Ventas
          doc.setFont(undefined, 'bold');
          doc.text("Datos de Contacto de Ventas:", 15, y);
          y += 6;
          doc.setFont(undefined, 'normal');
          doc.text(`Celular: 2381646718`, 15, y);
          y += 6;
          doc.text(`Correo: globalmedith@gmail.com`, 15, y);
          y += 6;
          doc.text(`Ubicaci√≥n: Tehuac√°n, Puebla`, 15, y);
          y += 10;

          // Datos del Cliente
          doc.setFont(undefined, 'bold');
          doc.text("Datos del Cliente:", 15, y);
          y += 6;
          doc.setFont(undefined, 'normal');
          doc.text(`Nombre: ${clientData.nombre || 'N/A'}`, 15, y);
          y += 6;
          doc.text(`Celular: ${clientData.celular || 'N/A'}`, 15, y);
          y += 6;
          doc.text(`Ciudad: ${clientData.ciudad || 'N/A'}`, 15, y);
          y += 6;
          doc.text(`Correo: ${clientData.correo || 'N/A'}`, 15, y);
          y += 10;

          // Productos seleccionados (usando autoTable)
          doc.setFont(undefined, 'bold');
          doc.text("Productos Seleccionados:", 15, y);
          y += 8;
          doc.setFont(undefined, 'normal');

          const headers = [["C√≥digo de Barras", "Descripci√≥n", "F√≥rmula", "Laboratorio", "Cantidad"]];
          const data = Array.from(selectedProducts.values()).map(p => [
            p.codigoBarras || 'N/A',
            p.descripcion || 'Sin descripci√≥n',
            p.formula || 'No especificada',
            p.laboratorio || 'No especificado',
            p.cantidad
          ]);

          doc.autoTable({
            startY: y,
            head: headers,
            body: data,
            styles: { fontSize: 8, cellPadding: 1.5, overflow: 'linebreak' },
            headStyles: { fillColor: [248, 249, 250], textColor: [44, 62, 80], fontStyle: 'bold' },
            alternateRowStyles: { fillColor: [248, 249, 250] },
            margin: { left: 15, right: 15 },
            didDrawPage: function(data) {
              doc.setFontSize(8);
              const pageCount = doc.internal.getNumberOfPages();
              doc.text(`P√°gina ${data.pageNumber} de ${pageCount}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
            }
          });
          
          const filename = `Cotizacion_GlobalMediTH_${(clientData.nombre || 'cliente').replace(/\s/g, '_')}.pdf`;
          doc.save(filename);
      });
    }

    // Enviar por WhatsApp
    function enviarWhatsApp() {
      const nombre = clientData.nombre || 'N/A';
      const celular = clientData.celular || 'N/A';
      const ciudad = clientData.ciudad || 'N/A';
      const correo = clientData.correo || 'N/A';

      let message = `¬°Hola GlobalMediTH!%0A%0AMe gustar√≠a solicitar una cotizaci√≥n con la siguiente informaci√≥n:%0A%0A`;
      
      message += `*Datos del Cliente:*%0A`;
      message += `üßë‚Äçüíª Nombre: ${nombre}%0A`;
      message += `üì± Celular: ${celular}%0A`;
      message += `üèôÔ∏è Ciudad: ${ciudad}%0A`;
      message += `üìß Correo: ${correo}%0A%0A`;

      message += `*Productos Solicitados:*%0A`;
      if (selectedProducts.size === 0) {
        message += "No se seleccionaron productos.";
      } else {
        selectedProducts.forEach(product => {
          message += `üíä ${product.descripcion} (C√≥d: ${product.codigoBarras || 'N/A'}) - Cantidad: ${product.cantidad}%0A`;
        });
      }

      message += `%0A¬°Espero su pronta respuesta!%0A%0AGracias.%0A%0A_Sistema de Cotizaci√≥n GlobalMediTH_`;

      const whatsappUrl = `https://wa.me/522381646718?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }
  </script>
</body>
</html>